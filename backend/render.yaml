# render.yaml
services:
  - type: web
    name: pigeon-backend
    env: python
    buildCommand: |
      echo "üöÄ –ó–ê–ü–£–°–ö –°–ë–û–†–ö–ò PIGEON MESSENGER"
      echo "=================================="
      
      # 1. –°–æ–∑–¥–∞–µ–º –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–µ —Ñ–∞–π–ª—ã –ø–µ—Ä–µ–¥ —É—Å—Ç–∞–Ω–æ–≤–∫–æ–π –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
      echo "üìÑ –°–æ–∑–¥–∞–Ω–∏–µ –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã—Ö —Ñ–∞–π–ª–æ–≤..."
      
      # –°–æ–∑–¥–∞–µ–º requirements.txt
      cat > requirements.txt << 'EOF'
      Django==5.2.3
      gunicorn==21.2.0
      whitenoise==6.6.0
      psycopg2-binary==2.9.9
      dj-database-url==2.1.0
      django-cors-headers==4.3.1
      EOF
      
      # –°–æ–∑–¥–∞–µ–º fix_imports.py
      cat > fix_imports.py << 'EOF'
      # fix_imports.py
      import os
      import re
      
      FILES_TO_CHECK = [
          'users/admin.py',
          'messenger/models.py',
          'notifications/models.py',
          'messenger/views.py',
          'users/views.py',
          'pigeon/urls.py',
      ]
      
      def fix_user_imports():
          """–ò—Å–ø—Ä–∞–≤–ª—è–µ—Ç –∏–º–ø–æ—Ä—Ç—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –≤–æ –≤—Å–µ—Ö —Ñ–∞–π–ª–∞—Ö"""
          print("üîß –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∏–º–ø–æ—Ä—Ç–æ–≤ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π...")
          
          for file_path in FILES_TO_CHECK:
              if not os.path.exists(file_path):
                  print(f"  ‚ö†Ô∏è –§–∞–π–ª {file_path} –Ω–µ –Ω–∞–π–¥–µ–Ω, –ø—Ä–æ–ø—É—Å–∫–∞–µ–º")
                  continue
                  
              with open(file_path, 'r', encoding='utf-8') as f:
                  content = f.read()
              
              original_content = content
              changes_made = False
              
              # –ü–∞—Ç—Ç–µ—Ä–Ω—ã –¥–ª—è –ø–æ–∏—Å–∫–∞ –∏ –∑–∞–º–µ–Ω—ã
              patterns = [
                  # –ò–º–ø–æ—Ä—Ç—ã CustomUser
                  (r'from\s+\.models\s+import\s+CustomUser', 
                   '# from .models import CustomUser  # –í—Ä–µ–º–µ–Ω–Ω–æ –æ—Ç–∫–ª—é—á–µ–Ω–æ'),
                  
                  # –ò–º–ø–æ—Ä—Ç—ã –∏–∑ users.models
                  (r'from\s+users\.models\s+import\s+CustomUser',
                   '# from users.models import CustomUser  # –í—Ä–µ–º–µ–Ω–Ω–æ –æ—Ç–∫–ª—é—á–µ–Ω–æ'),
                   
                  # get_user_model() –∑–∞–º–µ–Ω—è–µ–º –Ω–∞ settings.AUTH_USER_MODEL
                  (r'User\s*=\s*get_user_model\(\)',
                   'from django.conf import settings\nUser = settings.AUTH_USER_MODEL'),
              ]
              
              for pattern, replacement in patterns:
                  if re.search(pattern, content):
                      content = re.sub(pattern, replacement, content)
                      changes_made = True
              
              if changes_made:
                  with open(file_path, 'w', encoding='utf-8') as f:
                      f.write(content)
                  print(f"  ‚úÖ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω {file_path}")
              else:
                  print(f"  ‚úì {file_path} –Ω–µ —Ç—Ä–µ–±—É–µ—Ç –∏–∑–º–µ–Ω–µ–Ω–∏–π")
          
          print("‚úÖ –í—Å–µ –∏–º–ø–æ—Ä—Ç—ã –ø—Ä–æ–≤–µ—Ä–µ–Ω—ã!")
      
      if __name__ == '__main__':
          fix_user_imports()
      EOF
      
      # –°–æ–∑–¥–∞–µ–º check_db.py
      cat > check_db.py << 'EOF'
      # check_db.py
      import os
      import sys
      import django
      from django.db import connection
      
      os.environ.setdefault('DJANGO_SETTINGS_MODULE', 'pigeon.settings')
      django.setup()
      
      print("üîç –ü–†–û–í–ï–†–ö–ê –ë–ê–ó–´ –î–ê–ù–ù–´–•")
      print("=" * 50)
      
      try:
          with connection.cursor() as cursor:
              # –ü—Ä–æ–≤–µ—Ä—è–µ–º –æ—Å–Ω–æ–≤–Ω—ã–µ —Ç–∞–±–ª–∏—Ü—ã
              tables = ['auth_user', 'django_session', 'django_migrations']
              
              for table in tables:
                  cursor.execute(f"SELECT EXISTS (SELECT FROM information_schema.tables WHERE table_name = '{table}')")
                  exists = cursor.fetchone()[0]
                  status = "‚úÖ" if exists else "‚ùå"
                  print(f"{status} {table}: {'–°–£–©–ï–°–¢–í–£–ï–¢' if exists else '–û–¢–°–£–¢–°–¢–í–£–ï–¢'}")
              
              # –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
              cursor.execute("SELECT COUNT(*) FROM auth_user")
              count = cursor.fetchone()[0]
              print(f"üë• –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π: {count}")
              
              if count == 0:
                  print("üëë –°–æ–∑–¥–∞–µ–º —Å—É–ø–µ—Ä–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è...")
                  from django.contrib.auth.models import User
                  User.objects.create_superuser('admin', 'admin@example.com', 'admin123')
                  print("‚úÖ –°–æ–∑–¥–∞–Ω: admin/admin123")
                  
      except Exception as e:
          print(f"‚ùå –û—à–∏–±–∫–∞: {e}")
      
      print("=" * 50)
      EOF
      
      # 2. –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
      echo "üì¶ –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π..."
      pip install --upgrade pip
      pip install -r requirements.txt
      
      # 3. –ò—Å–ø—Ä–∞–≤–ª—è–µ–º –∏–º–ø–æ—Ä—Ç—ã
      echo "üîß –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∏–º–ø–æ—Ä—Ç–æ–≤..."
      python fix_imports.py
      
      # 4. –°–æ–∑–¥–∞–µ–º —Å—Ç—Ä—É–∫—Ç—É—Ä—É –ø–∞–ø–æ–∫
      echo "üìÅ –°–æ–∑–¥–∞–Ω–∏–µ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã..."
      mkdir -p static/css static/js static/images
      mkdir -p staticfiles
      mkdir -p media
      mkdir -p templates/registration
      mkdir -p sessions
      
      # 5. –°–æ–∑–¥–∞–µ–º –±–∞–∑–æ–≤—ã–µ —Ñ–∞–π–ª—ã
      echo "üé® –°–æ–∑–¥–∞–Ω–∏–µ –±–∞–∑–æ–≤—ã—Ö —Ñ–∞–π–ª–æ–≤..."
      
      # CSS
      cat > static/css/style.css << 'EOF'
      /* –û—Å–Ω–æ–≤–Ω—ã–µ —Å—Ç–∏–ª–∏ */
      body {
          margin: 0;
          padding: 20px;
          font-family: Arial, sans-serif;
          background: #f5f5f5;
      }
      .container {
          max-width: 1200px;
          margin: 0 auto;
      }
      EOF
      
      # JS
      echo "console.log('Pigeon Messenger loaded');" > static/js/main.js
      
      # –ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ-–∑–∞–≥–ª—É—à–∫–∞
      echo "data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVR42mNkYPhfDwAChwGA60e6kgAAAABJRU5ErkJggg==" | base64 -d > static/images/Pigeon.png 2>/dev/null || echo "placeholder" > static/images/Pigeon.png
      
      # –ü—Ä–æ—Å—Ç–æ–π —à–∞–±–ª–æ–Ω –≤—Ö–æ–¥–∞
      cat > templates/registration/login.html << 'EOF'
      <!DOCTYPE html>
      <html>
      <head>
          <title>Pigeon Messenger - Login</title>
          <style>
              body { font-family: Arial; background: #f0f2f5; height: 100vh; display: flex; align-items: center; justify-content: center; margin: 0; }
              .login-box { background: white; padding: 40px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); width: 300px; }
              h1 { text-align: center; color: #1877f2; margin-bottom: 20px; }
              input { width: 100%; padding: 10px; margin: 8px 0; border: 1px solid #ddd; border-radius: 4px; box-sizing: border-box; }
              button { width: 100%; padding: 10px; background: #1877f2; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 16px; }
              button:hover { background: #166fe5; }
              .error { color: #ff3333; font-size: 14px; margin-bottom: 10px; }
              .info { background: #e7f3ff; padding: 10px; border-radius: 4px; margin-top: 15px; font-size: 14px; }
          </style>
      </head>
      <body>
          <div class="login-box">
              <h1>üê¶ Pigeon</h1>
              
              {% if form.errors %}
                  <div class="error">–ù–µ–≤–µ—Ä–Ω–æ–µ –∏–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–ª–∏ –ø–∞—Ä–æ–ª—å.</div>
              {% endif %}
              
              <form method="post">
                  {% csrf_token %}
                  <input type="text" name="username" placeholder="–ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è" required>
                  <input type="password" name="password" placeholder="–ü–∞—Ä–æ–ª—å" required>
                  <button type="submit">–í–æ–π—Ç–∏</button>
              </form>
              
              <div class="info">
                  <strong>–¢–µ—Å—Ç–æ–≤—ã–π –¥–æ—Å—Ç—É–ø:</strong><br>
                  –õ–æ–≥–∏–Ω: <code>admin</code><br>
                  –ü–∞—Ä–æ–ª—å: <code>admin123</code>
              </div>
          </div>
      </body>
      </html>
      EOF
      
      # 6. –ü—Ä–æ–≤–µ—Ä—è–µ–º –∏ —Å–æ–∑–¥–∞–µ–º —Ç–∞–±–ª–∏—Ü—ã
      echo "üóÑÔ∏è  –ü—Ä–æ–≤–µ—Ä–∫–∞ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö..."
      python check_db.py
      
      # 7. –í—ã–ø–æ–ª–Ω—è–µ–º –º–∏–≥—Ä–∞—Ü–∏–∏ Django
      echo "üîÑ –í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –º–∏–≥—Ä–∞—Ü–∏–π..."
      python manage.py makemigrations --noinput || echo "‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å –º–∏–≥—Ä–∞—Ü–∏–∏"
      python manage.py migrate --noinput || echo "‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å –ø—Ä–∏–º–µ–Ω–∏—Ç—å –º–∏–≥—Ä–∞—Ü–∏–∏"
      
      # 8. –°–æ–∑–¥–∞–µ–º —Å—É–ø–µ—Ä–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (–¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞)
      echo "üëë –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—É–ø–µ—Ä–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è..."
      echo "from django.contrib.auth import get_user_model; User = get_user_model(); User.objects.create_superuser('admin', 'admin@example.com', 'admin123') if not User.objects.filter(username='admin').exists() else print('‚úÖ –°—É–ø–µ—Ä–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç')" | python manage.py shell
      
      # 9. –°–æ–±–∏—Ä–∞–µ–º —Å—Ç–∞—Ç–∏–∫—É
      echo "üì¶ –°–±–æ—Ä–∫–∞ —Å—Ç–∞—Ç–∏—á–µ—Å–∫–∏—Ö —Ñ–∞–π–ª–æ–≤..."
      python manage.py collectstatic --noinput --clear
      
      # 10. –°–æ–∑–¥–∞–µ–º .env —Ñ–∞–π–ª –µ—Å–ª–∏ –µ–≥–æ –Ω–µ—Ç
      echo "‚öôÔ∏è  –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –æ–∫—Ä—É–∂–µ–Ω–∏—è..."
      if [ ! -f .env ]; then
          cat > .env << 'EOF'
      DEBUG=False
      SECRET_KEY=$(python -c "from django.core.management.utils import get_random_secret_key; print(get_random_secret_key())")
      ALLOWED_HOSTS=.onrender.com,localhost,127.0.0.1
      EOF
      fi
      
      echo "=================================="
      echo "‚úÖ –°–ë–û–†–ö–ê –ó–ê–í–ï–†–®–ï–ù–ê –£–°–ü–ï–®–ù–û!"
      echo "=================================="
      echo ""
      echo "üåê –°–∞–π—Ç –±—É–¥–µ—Ç –¥–æ—Å—Ç—É–ø–µ–Ω –ø–æ –∞–¥—Ä–µ—Å—É:"
      echo "   https://–≤–∞—à-–ø—Ä–æ–µ–∫—Ç.onrender.com"
      echo ""
      echo "üîë –£—á–µ—Ç–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –¥–ª—è –≤—Ö–æ–¥–∞:"
      echo "   –õ–æ–≥–∏–Ω: admin"
      echo "   –ü–∞—Ä–æ–ª—å: admin123"
      echo ""
      echo "üîÑ –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫ —Å–µ—Ä–≤–µ—Ä–∞..."
      
    startCommand: |
      echo "üöÄ –ó–ê–ü–£–°–ö –°–ï–†–í–ï–†–ê PIGEON MESSENGER"
      echo "=================================="
      echo "üîß –ü—Ä–æ–≤–µ—Ä–∫–∞ –æ–∫—Ä—É–∂–µ–Ω–∏—è..."
      
      # –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è
      if [ -z "$DATABASE_URL" ]; then
          echo "‚ùå –û–®–ò–ë–ö–ê: DATABASE_URL –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω!"
          exit 1
      fi
      
      echo "‚úÖ DATABASE_URL –Ω–∞—Å—Ç—Ä–æ–µ–Ω"
      echo "üåê –ó–∞–ø—É—Å–∫ Gunicorn –Ω–∞ –ø–æ—Ä—Ç—É $PORT..."
      
      # –ó–∞–ø—É—Å–∫–∞–µ–º Gunicorn
      gunicorn pigeon.wsgi:application \
        --bind 0.0.0.0:$PORT \
        --workers 2 \
        --timeout 120 \
        --access-logfile - \
        --error-logfile - \
        --log-level info
      
    envVars:
      - key: DATABASE_URL
        fromDatabase:
          name: pigeon-db
          property: connectionString
      - key: SECRET_KEY
        generateValue: true
      - key: DEBUG
        value: false
      - key: PYTHON_VERSION
        value: 3.11.0
      - key: DISABLE_COLLECTSTATIC
        value: 0
      - key: DJANGO_SETTINGS_MODULE
        value: pigeon.settings
      - key: PYTHONUNBUFFERED
        value: 1
    autoDeploy: true
    healthCheckPath: /
    numInstances: 1
    disk:
      name: data
      mountPath: /opt/render/project/data
      sizeGB: 1

databases:
  - name: pigeon-db
    databaseName: pigeon
    user: pigeon_user
    plan: free
    ipAllowList:
      - source: 0.0.0.0/0
        description: everywhere