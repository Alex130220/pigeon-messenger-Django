services:
  - type: web
    name: pigeon-backend
    env: python
    buildCommand: |
      # 1. Ğ¡Ğ¾Ğ·Ğ´Ğ°ĞµĞ¼ Ğ±Ğ°Ğ·Ğ¾Ğ²Ñ‹Ğµ Ğ´Ğ¸Ñ€ĞµĞºÑ‚Ğ¾Ñ€Ğ¸Ğ¸
      mkdir -p static/css static/js static/images
      mkdir -p staticfiles media sessions
      
      # 2. Ğ£ÑÑ‚Ğ°Ğ½Ğ°Ğ²Ğ»Ğ¸Ğ²Ğ°ĞµĞ¼ Ğ·Ğ°Ğ²Ğ¸ÑĞ¸Ğ¼Ğ¾ÑÑ‚Ğ¸
      pip install -r requirements.txt
      
      # 3. Ğ­ĞšĞ¡Ğ¢Ğ Ğ•ĞĞĞĞ• ÑĞ¾Ğ·Ğ´Ğ°Ğ½Ğ¸Ğµ Ñ‚Ğ°Ğ±Ğ»Ğ¸Ñ†Ñ‹
      echo "ğŸš¨ Ğ­ĞšĞ¡Ğ¢Ğ Ğ•ĞĞĞĞ• Ğ¡ĞĞ—Ğ”ĞĞĞ˜Ğ• Ğ¢ĞĞ‘Ğ›Ğ˜Ğ¦Ğ« users_customuser..."
      
      # Ğ¡Ğ¾Ğ·Ğ´Ğ°ĞµĞ¼ Ñ„Ğ°Ğ¹Ğ» Ñ SQL ĞºĞ¾Ğ¼Ğ°Ğ½Ğ´Ğ¾Ğ¹
      cat > create_table.sql << 'EOF'
      DO $$
      BEGIN
          IF NOT EXISTS (SELECT FROM pg_tables WHERE schemaname = 'public' AND tablename = 'users_customuser') THEN
              CREATE TABLE users_customuser (
                  id SERIAL PRIMARY KEY,
                  password VARCHAR(128) NOT NULL,
                  last_login TIMESTAMP WITH TIME ZONE NULL,
                  is_superuser BOOLEAN NOT NULL,
                  username VARCHAR(150) UNIQUE NOT NULL,
                  first_name VARCHAR(150) NOT NULL,
                  last_name VARCHAR(150) NOT NULL,
                  email VARCHAR(254) NOT NULL,
                  is_staff BOOLEAN NOT NULL,
                  is_active BOOLEAN NOT NULL,
                  date_joined TIMESTAMP WITH TIME ZONE NOT NULL,
                  avatar VARCHAR(100),
                  phone VARCHAR(20),
                  bio TEXT,
                  birth_date DATE,
                  position VARCHAR(100)
              );
              RAISE NOTICE 'Table users_customuser created';
          END IF;
      END $$;
      EOF
      
      # ĞŸÑ‹Ñ‚Ğ°ĞµĞ¼ÑÑ Ğ²Ñ‹Ğ¿Ğ¾Ğ»Ğ½Ğ¸Ñ‚ÑŒ Ñ‡ĞµÑ€ĞµĞ· Python
      python -c "
      import os
      import sys
      
      os.environ.setdefault('DJANGO_SETTINGS_MODULE', 'pigeon.settings')
      
      try:
          import django
          django.setup()
          
          from django.db import connection
          
          with open('create_table.sql', 'r') as f:
              sql = f.read()
          
          with connection.cursor() as cursor:
              cursor.execute(sql)
              print('SQL executed successfully')
              
              # ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼
              cursor.execute(\"SELECT EXISTS (SELECT FROM pg_tables WHERE schemaname = 'public' AND tablename = 'users_customuser')\")
              exists = cursor.fetchone()[0]
              
              if exists:
                  print('âœ… Table users_customuser exists')
                  
                  # Ğ¡Ğ¾Ğ·Ğ´Ğ°ĞµĞ¼ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ
                  from django.contrib.auth import get_user_model
                  User = get_user_model()
                  
                  try:
                      if not User.objects.filter(username='admin').exists():
                          User.objects.create_superuser('admin', 'admin@example.com', 'admin123')
                          print('âœ… Superuser created')
                      else:
                          print('â„¹ï¸ Superuser already exists')
                  except Exception as e:
                      print(f'âš ï¸ Error creating user: {e}')
              else:
                  print('âŒ Table still does not exist')
                  
      except Exception as e:
          print(f'âŒ Error: {e}')
          import traceback
          traceback.print_exc()
      "
      
      # 4. ĞŸÑ€Ğ¾Ğ±ÑƒĞµĞ¼ ÑÑ‚Ğ°Ğ½Ğ´Ğ°Ñ€Ñ‚Ğ½Ñ‹Ğµ Ğ¼Ğ¸Ğ³Ñ€Ğ°Ñ†Ğ¸Ğ¸
      echo "ğŸ”„ ĞŸÑ€Ğ¾Ğ±ÑƒĞµĞ¼ ÑÑ‚Ğ°Ğ½Ğ´Ğ°Ñ€Ñ‚Ğ½Ñ‹Ğµ Ğ¼Ğ¸Ğ³Ñ€Ğ°Ñ†Ğ¸Ğ¸..."
      python manage.py migrate --noinput || echo "âš ï¸ Migrations failed"
      
      # 5. Ğ¡Ğ¾Ğ±Ğ¸Ñ€Ğ°ĞµĞ¼ ÑÑ‚Ğ°Ñ‚Ğ¸ĞºÑƒ
      echo "ğŸ¨ Ğ¡Ğ±Ğ¾Ñ€ĞºĞ° ÑÑ‚Ğ°Ñ‚Ğ¸Ñ‡ĞµÑĞºĞ¸Ñ… Ñ„Ğ°Ğ¹Ğ»Ğ¾Ğ²..."
      python manage.py collectstatic --noinput --clear
      
      echo "âœ… Build complete!"
    startCommand: gunicorn pigeon.wsgi:application --bind 0.0.0.0:$PORT
    envVars:
      - key: DATABASE_URL
        fromDatabase:
          name: pigeon-db
          property: connectionString
      - key: SECRET_KEY
        generateValue: true
      - key: DEBUG
        value: false
      - key: PYTHON_VERSION
        value: 3.11.0
      - key: CREATE_USERS
        value: "true"