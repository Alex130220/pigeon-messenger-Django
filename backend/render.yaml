# render.yaml
services:
  - type: web
    name: pigeon-backend
    env: python
    buildCommand: |
      echo "ğŸš€ Ğ—ĞĞŸĞ£Ğ¡Ğš Ğ¡Ğ‘ĞĞ ĞšĞ˜ PIGEON MESSENGER"
      echo "=================================="
      
      # 0. Ğ¡ĞĞœĞĞ• Ğ’ĞĞ–ĞĞĞ•: Ğ—Ğ°Ğ¼ĞµĞ½ÑĞµĞ¼ users/admin.py Ğ½Ğ° Ñ€Ğ°Ğ±Ğ¾Ñ‡ÑƒÑ Ğ²ĞµÑ€ÑĞ¸Ñ
      echo "ğŸ”§ Ğ¡ĞĞ—Ğ”ĞĞ•Ğœ Ğ ĞĞ‘ĞĞ§Ğ˜Ğ™ users/admin.py..."
      cat > users/admin.py << 'EOF'
      # users/admin.py - Ğ’Ğ•Ğ Ğ¡Ğ˜Ğ¯ Ğ”Ğ›Ğ¯ RENDER.COM
      
      import os
      
      # ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼, Ñ€Ğ°Ğ±Ğ¾Ñ‚Ğ°ĞµĞ¼ Ğ»Ğ¸ Ğ¼Ñ‹ Ğ½Ğ° Render
      IS_RENDER = 'RENDER' in os.environ
      
      if IS_RENDER:
          # ĞĞ RENDER: ĞĞ˜Ğ§Ğ•Ğ“Ğ ĞĞ• Ğ”Ğ•Ğ›ĞĞ•Ğœ!
          print("ğŸ¦ PIGEON: Ğ˜ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞµÑ‚ÑÑ ÑÑ‚Ğ°Ğ½Ğ´Ğ°Ñ€Ñ‚Ğ½Ğ°Ñ Ğ¼Ğ¾Ğ´ĞµĞ»ÑŒ auth.User")
          print("ğŸ’¡ ĞœĞ¾Ğ´ĞµĞ»ÑŒ ÑƒĞ¶Ğµ Ğ·Ğ°Ñ€ĞµĞ³Ğ¸ÑÑ‚Ñ€Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ° Django Ğ°Ğ²Ñ‚Ğ¾Ğ¼Ğ°Ñ‚Ğ¸Ñ‡ĞµÑĞºĞ¸")
          
          # Ğ’ĞĞ–ĞĞ: ĞĞµ Ñ€ĞµĞ³Ğ¸ÑÑ‚Ñ€Ğ¸Ñ€ÑƒĞµĞ¼ User, Ğ¾Ğ½ ÑƒĞ¶Ğµ Ğ·Ğ°Ñ€ĞµĞ³Ğ¸ÑÑ‚Ñ€Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½
          # Ğ›ÑĞ±Ğ°Ñ Ğ¿Ğ¾Ğ¿Ñ‹Ñ‚ĞºĞ° admin.site.register() Ğ²Ñ‹Ğ·Ğ¾Ğ²ĞµÑ‚ Ğ¾ÑˆĞ¸Ğ±ĞºÑƒ
          
      else:
          # Ğ”Ğ»Ñ Ğ»Ğ¾ĞºĞ°Ğ»ÑŒĞ½Ğ¾Ğ¹ Ñ€Ğ°Ğ·Ñ€Ğ°Ğ±Ğ¾Ñ‚ĞºĞ¸
          try:
              from django.contrib import admin
              from django.contrib.auth.admin import UserAdmin
              from .models import CustomUser
              
              class CustomUserAdmin(UserAdmin):
                  list_display = ('username', 'email', 'first_name', 'last_name', 'position')
                  fieldsets = UserAdmin.fieldsets + (
                      ('Ğ”Ğ¾Ğ¿Ğ¾Ğ»Ğ½Ğ¸Ñ‚ĞµĞ»ÑŒĞ½Ğ°Ñ Ğ¸Ğ½Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ†Ğ¸Ñ', {'fields': ('position', 'phone')}),
                  )
              
              admin.site.register(CustomUser, CustomUserAdmin)
              print("âœ… Ğ›Ğ¾ĞºĞ°Ğ»ÑŒĞ½Ğ¾: Ğ˜ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞµÑ‚ÑÑ CustomUser")
              
          except ImportError:
              # Ğ•ÑĞ»Ğ¸ CustomUser Ğ½Ğµ ÑÑƒÑ‰ĞµÑÑ‚Ğ²ÑƒĞµÑ‚
              from django.contrib import admin
              from django.contrib.auth.admin import UserAdmin
              from django.contrib.auth.models import User
              admin.site.register(User, UserAdmin)
              print("âš ï¸ Ğ›Ğ¾ĞºĞ°Ğ»ÑŒĞ½Ğ¾: Ğ˜ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞµÑ‚ÑÑ ÑÑ‚Ğ°Ğ½Ğ´Ğ°Ñ€Ñ‚Ğ½Ñ‹Ğ¹ User")
      
      EOF
      
      echo "âœ… users/admin.py ÑĞ¾Ğ·Ğ´Ğ°Ğ½"
      
      # 1. ĞŸÑ€Ğ¾Ğ´Ğ¾Ğ»Ğ¶Ğ°ĞµĞ¼ Ğ¾ÑÑ‚Ğ°Ğ»ÑŒĞ½ÑƒÑ ÑĞ±Ğ¾Ñ€ĞºÑƒ...
      echo "ğŸ“¦ Ğ£ÑÑ‚Ğ°Ğ½Ğ¾Ğ²ĞºĞ° Ğ·Ğ°Ğ²Ğ¸ÑĞ¸Ğ¼Ğ¾ÑÑ‚ĞµĞ¹..."
      pip install --upgrade pip
      pip install django==5.2.3 gunicorn==21.2.0 whitenoise==6.6.0
      pip install psycopg2-binary==2.9.9 dj-database-url==2.1.0
      
      # 2. Ğ¡Ğ¾Ğ·Ğ´Ğ°ĞµĞ¼ ÑÑ‚Ñ€ÑƒĞºÑ‚ÑƒÑ€Ñƒ
      echo "ğŸ“ Ğ¡Ğ¾Ğ·Ğ´Ğ°Ğ½Ğ¸Ğµ ÑÑ‚Ñ€ÑƒĞºÑ‚ÑƒÑ€Ñ‹..."
      mkdir -p staticfiles media sessions
      
      # 3. Ğ’Ñ‹Ğ¿Ğ¾Ğ»Ğ½ÑĞµĞ¼ Ğ¢ĞĞ›Ğ¬ĞšĞ Ğ¡Ğ¢ĞĞĞ”ĞĞ Ğ¢ĞĞ«Ğ• Ğ¼Ğ¸Ğ³Ñ€Ğ°Ñ†Ğ¸Ğ¸
      echo "ğŸ”„ Ğ’Ñ‹Ğ¿Ğ¾Ğ»Ğ½ĞµĞ½Ğ¸Ğµ Ğ¼Ğ¸Ğ³Ñ€Ğ°Ñ†Ğ¸Ğ¹..."
      python manage.py migrate auth --noinput
      python manage.py migrate contenttypes --noinput
      python manage.py migrate sessions --noinput
      python manage.py migrate admin --noinput
      
      # 4. Ğ¡Ğ¾Ğ·Ğ´Ğ°ĞµĞ¼ ÑÑƒĞ¿ĞµÑ€Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ
      echo "ğŸ‘‘ Ğ¡Ğ¾Ğ·Ğ´Ğ°Ğ½Ğ¸Ğµ ÑÑƒĞ¿ĞµÑ€Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ..."
      echo "from django.contrib.auth.models import User; User.objects.create_superuser('admin', 'admin@example.com', 'admin123') if not User.objects.filter(username='admin').exists() else print('âœ… admin ÑƒĞ¶Ğµ ÑÑƒÑ‰ĞµÑÑ‚Ğ²ÑƒĞµÑ‚')" | python manage.py shell
      
      # 5. Ğ¡Ğ¾Ğ±Ğ¸Ñ€Ğ°ĞµĞ¼ ÑÑ‚Ğ°Ñ‚Ğ¸ĞºÑƒ
      echo "ğŸ“¦ Ğ¡Ğ±Ğ¾Ñ€ĞºĞ° ÑÑ‚Ğ°Ñ‚Ğ¸Ñ‡ĞµÑĞºĞ¸Ñ… Ñ„Ğ°Ğ¹Ğ»Ğ¾Ğ²..."
      python manage.py collectstatic --noinput --clear
      
      echo "=================================="
      echo "âœ… Ğ¡Ğ‘ĞĞ ĞšĞ Ğ—ĞĞ’Ğ•Ğ Ğ¨Ğ•ĞĞ!"
      echo "ğŸ”‘ Ğ’Ñ…Ğ¾Ğ´: admin / admin123"
      
    startCommand: |
      echo "ğŸš€ Ğ—ĞĞŸĞ£Ğ¡Ğš Ğ¡Ğ•Ğ Ğ’Ğ•Ğ Ğ..."
      gunicorn pigeon.wsgi:application --bind 0.0.0.0:$PORT --workers 2 --timeout 120
      
    envVars:
      - key: DATABASE_URL
        fromDatabase:
          name: pigeon-db
          property: connectionString
      - key: SECRET_KEY
        generateValue: true
      - key: DEBUG
        value: false
      - key: PYTHON_VERSION
        value: 3.11.0
      - key: DISABLE_COLLECTSTATIC
        value: 0
    autoDeploy: true
    healthCheckPath: /

databases:
  - name: pigeon-db
    databaseName: pigeon
    user: pigeon_user
    plan: free