services:
  - type: web
    name: pigeon-backend
    env: python
    buildCommand: |
  echo "üöÄ –ù–ê–ß–ê–õ–û –°–ë–û–†–ö–ò..."
  echo "=================="
  
  # 1. –û–±–Ω–æ–≤–ª—è–µ–º pip
  pip install --upgrade pip
  
  # 2. –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –í–°–ï –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
  echo "üì¶ –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π..."
  pip install django==5.2.3
  pip install gunicorn==21.2.0
  pip install whitenoise==6.6.0
  pip install psycopg2-binary==2.9.9
  pip install dj-database-url==2.1.0
  pip install django-cors-headers==4.3.1
  pip install channels==4.1.0
  pip install daphne==4.1.0
  pip install django-otp==1.4.1
  pip install django-two-factor-auth==1.15.3
  pip install djangorestframework==3.15.2
  
  # 3. –°–û–ó–î–ê–ï–ú –º–∏–≥—Ä–∞—Ü–∏–∏ –¥–ª—è –í–°–ï–• –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–π
  echo "üîÑ –°–æ–∑–¥–∞–Ω–∏–µ –º–∏–≥—Ä–∞—Ü–∏–π..."
  python manage.py makemigrations users messenger notifications --noinput
  
  # 4. –ü–†–ò–ú–ï–ù–Ø–ï–ú –í–°–ï –º–∏–≥—Ä–∞—Ü–∏–∏
  echo "üìä –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –º–∏–≥—Ä–∞—Ü–∏–π..."
  python manage.py migrate --noinput
  
  # 5. –°–æ–∑–¥–∞–µ–º –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏
  echo "üìÅ –°–æ–∑–¥–∞–Ω–∏–µ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–π..."
  mkdir -p static/css static/js static/images
  mkdir -p staticfiles
  mkdir -p media
  mkdir -p sessions
  
  # 6. –°–æ–∑–¥–∞–µ–º –±–∞–∑–æ–≤—ã–µ —Å—Ç–∞—Ç–∏—á–µ—Å–∫–∏–µ —Ñ–∞–π–ª—ã
  echo "üé® –°–æ–∑–¥–∞–Ω–∏–µ —Å—Ç–∞—Ç–∏—á–µ—Å–∫–∏—Ö —Ñ–∞–π–ª–æ–≤..."
  echo "/* –ë–∞–∑–æ–≤—ã–µ —Å—Ç–∏–ª–∏ */ body { margin: 0; padding: 20px; font-family: sans-serif; }" > static/css/style.css
  echo "console.log('App loaded');" > static/js/main.js
  echo "placeholder" > static/images/Pigeon.png
  
  # 7. –°–æ–∑–¥–∞–µ–º —Å—É–ø–µ—Ä–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
  echo "üëë –°–æ–∑–¥–∞–Ω–∏–µ —Å—É–ø–µ—Ä–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è..."
  if [ -z "$(echo "from django.contrib.auth import get_user_model; User = get_user_model(); print(User.objects.filter(username='admin').exists())" | python manage.py shell)" ]; then
    echo "from django.contrib.auth import get_user_model; User = get_user_model(); User.objects.create_superuser('admin', 'admin@example.com', 'admin123') if not User.objects.filter(username='admin').exists() else None" | python manage.py shell
  fi
  
  # 8. –°–æ–±–∏—Ä–∞–µ–º —Å—Ç–∞—Ç–∏–∫—É
  echo "üìä –°–±–æ—Ä–∫–∞ —Å—Ç–∞—Ç–∏—á–µ—Å–∫–∏—Ö —Ñ–∞–π–ª–æ–≤..."
  python manage.py collectstatic --noinput --clear
      
      echo "‚úÖ –°–ë–û–†–ö–ê –ó–ê–í–ï–†–®–ï–ù–ê!"
      echo "=================="
    startCommand: gunicorn pigeon.wsgi:application --bind 0.0.0.0:$PORT
    envVars:
      - key: DATABASE_URL
        fromDatabase:
          name: pigeon-db
          property: connectionString
      - key: SECRET_KEY
        generateValue: true
      - key: DEBUG
        value: false
      - key: PYTHON_VERSION
        value: 3.11.0
      - key: DISABLE_COLLECTSTATIC
        value: 0
    autoDeploy: true

databases:
  - name: pigeon-db
    databaseName: pigeon
    user: pigeon_user
    plan: free