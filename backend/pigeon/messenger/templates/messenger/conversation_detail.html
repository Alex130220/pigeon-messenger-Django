{% extends 'base.html' %}

{% block content %}
<div class="container py-5">
    <div class="card">
        <div class="card-header d-flex justify-content-between align-items-center">
            <h5>
                {% for user in conversation.participants.all %}
                    {% if user != request.user %}{{ user.get_full_name }}{% endif %}
                {% endfor %}
            </h5>
            <a href="{% url 'messenger:conversation_list' %}" class="btn btn-sm btn-outline-secondary">
                Назад к списку
            </a>
        </div>
        
        <div class="card-body chat-messages" style="height: 60vh; overflow-y: auto;">
            {% for message in conversation.messages.all %}
                <div class="mb-3 {% if message.sender == request.user %}text-end{% endif %}">
                    <div class="d-flex {% if message.sender == request.user %}justify-content-end{% else %}justify-content-start{% endif %}">
                        <div class="message-bubble {% if message.sender == request.user %}bg-primary text-white{% else %}bg-light{% endif %}">
                            {{ message.content }}
                            <div class="message-time small text-muted mt-1">
                                {{ message.timestamp|time }}
                                {% if message.is_read and message.sender == request.user %}
                                    <i class="fas fa-check ms-1"></i>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>
            {% endfor %}
        </div>
        
        <div class="card-footer">
            <form method="post">
                {% csrf_token %}
                <div class="input-group">
                    {{ form.content }}
                    <button type="submit" class="btn btn-primary">Отправить</button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
    // Автоматическая прокрутка вниз
    const messagesContainer = document.querySelector('.chat-messages');
    messagesContainer.scrollTop = messagesContainer.scrollHeight;
const conversationId = {{ conversation.id }};
    const currentUser = "{{ request.user.username }}";
    
    const chatSocket = new WebSocket(
    `ws://${window.location.host}/ws/chat/${conversationId}/`  # Уже правильно
);
    
    chatSocket.onmessage = function(e) {
        const data = JSON.parse(e.data);
        const messagesContainer = document.querySelector('.chat-messages');
        
        const messageElement = document.createElement('div');
        messageElement.className = `mb-3 ${data.sender === currentUser ? 'text-end' : ''}`;
        
        messageElement.innerHTML = `
            <div class="d-flex ${data.sender === currentUser ? 'justify-content-end' : 'justify-content-start'}">
                <div class="message-bubble ${data.sender === currentUser ? 'bg-primary text-white' : 'bg-light'}">
                    ${data.message}
                    <div class="message-time small text-muted mt-1">
                        ${new Date(data.timestamp).toLocaleTimeString()}
                        ${data.sender === currentUser ? '<i class="fas fa-check ms-1"></i>' : ''}
                    </div>
                </div>
            </div>
        `;
        
        messagesContainer.appendChild(messageElement);
        messagesContainer.scrollTop = messagesContainer.scrollHeight;
    };
    
    chatSocket.onclose = function(e) {
        console.error('Chat socket closed unexpectedly');
    };
</script>
{% endblock %}