{% extends 'base.html' %}
{% load static %}

{% block title %}Чат с {{ recipient.get_full_name }}{% endblock %}

{% block content %}
<div class="chat-container">
    <!-- Список чатов -->
    <div class="chat-list">
        <div class="chat-list-header">
            <h5>Мои чаты</h5>
        </div>
        <div class="chat-search">
            <input type="text" class="form-control" placeholder="Поиск чатов...">
        </div>
        <div class="chat-items">
            {% for chat in chats %}
            <div class="chat-item {% if chat.id == current_chat.id %}active{% endif %}" 
                 onclick="location.href='{% url 'messenger:chat' chat.id %}'">
                <div class="d-flex justify-content-between align-items-center">
                    <div class="d-flex align-items-center gap-2">
                        <div class="avatar">
                            <img src="{% static 'images/avatar-placeholder.png' %}" class="rounded-circle" width="40" height="40">
                        </div>
                        <div>
                            <h6 class="mb-0">{{ chat.get_other_user.get_full_name }}</h6>
                            <small class="text-muted">@{{ chat.get_other_user.username }}</small>
                        </div>
                    </div>
                    <small class="text-muted">{{ chat.last_message.timestamp|timesince }} назад</small>
                </div>
                <p class="mb-0 mt-2 text-truncate">
                    {% if chat.last_message.sender == request.user %}
                    <span class="text-muted">Вы:</span> {{ chat.last_message.content|truncatechars:30 }}
                    {% else %}
                    {{ chat.last_message.content|truncatechars:30 }}
                    {% endif %}
                </p>
            </div>
            {% endfor %}
        </div>
    </div>

    <!-- Окно чата -->
    <div class="chat-window">
        <div class="chat-header">
            <div class="avatar">
                <img src="{% static 'images/avatar-placeholder.png' %}" class="rounded-circle" width="40" height="40">
            </div>
            <div class="flex-grow-1">
                <h5 class="mb-0">{{ recipient.get_full_name }}</h5>
                <small class="text-muted">@{{ recipient.username }}</small>
            </div>
            <div class="dropdown">
                <button class="btn btn-sm btn-outline-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown">
                    <i class="fas fa-ellipsis-v"></i>
                </button>
                <ul class="dropdown-menu dropdown-menu-end">
                    <li><a class="dropdown-item" href="#"><i class="fas fa-info-circle me-2"></i>Информация</a></li>
                    <li><a class="dropdown-item" href="#"><i class="fas fa-trash-alt me-2"></i>Очистить историю</a></li>
                    <li><hr class="dropdown-divider"></li>
                    <li><a class="dropdown-item text-danger" href="#"><i class="fas fa-user-times me-2"></i>Удалить чат</a></li>
                </ul>
            </div>
        </div>
        
        <div class="chat-messages" id="chat-messages">
            {% for message in messages %}
            <div class="message {% if message.sender == request.user %}message-out{% else %}message-in{% endif %}">
                <div class="message-content">{{ message.content }}</div>
                <div class="message-time">
                    {{ message.timestamp|time }}
                    {% if message.sender == request.user %}
                    <i class="fas fa-check{% if message.is_read %}-double text-info{% endif %} ms-1"></i>
                    {% endif %}
                </div>
            </div>
            {% endfor %}
        </div>
        
        <div class="chat-input">
            <form method="post" class="d-flex gap-2">
                {% csrf_token %}
                <input type="text" name="message" class="form-control" placeholder="Напишите сообщение..." required>
                <button type="submit" class="btn btn-primary">
                    <i class="fas fa-paper-plane"></i>
                </button>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    // Автоскролл вниз
    const messagesContainer = document.getElementById('chat-messages');
    messagesContainer.scrollTop = messagesContainer.scrollHeight;
    
    // WebSocket подключение
    const conversationId = {{ current_chat.id }};
    const chatSocket = new WebSocket(
        `ws://${window.location.host}/ws/chat/${conversationId}/`
    );
    
    chatSocket.onmessage = function(e) {
        const data = JSON.parse(e.data);
        const isCurrentUser = data.sender === "{{ request.user.username }}";
        
        const messageElement = document.createElement('div');
        messageElement.className = `message ${isCurrentUser ? 'message-out' : 'message-in'}`;
        messageElement.innerHTML = `
            <div class="message-content">${data.message}</div>
            <div class="message-time">
                ${new Date(data.timestamp).toLocaleTimeString()}
                ${isCurrentUser ? '<i class="fas fa-check ms-1"></i>' : ''}
            </div>
        `;
        
        messagesContainer.appendChild(messageElement);
        messagesContainer.scrollTop = messagesContainer.scrollHeight;
    };
    
    chatSocket.onclose = function(e) {
        console.error('Chat socket closed unexpectedly');
    };
</script>
{% endblock %}